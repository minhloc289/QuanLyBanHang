CREATE DATABASE QLBH
USE QLBH
-- TẠO BẢNG --
CREATE TABLE KHACHHANG 
(
	MAKH char(4) NOT NULL,
	HOTEN varchar(40),
	DCHI varchar(50),
	SODT varchar(20),
	NGSINH datetime,
	DOANHSO money,
	NGDK datetime,
	CONSTRAINT PK_KH PRIMARY KEY (MAKH)
)

CREATE TABLE NHANVIEN 
(
	MANV char(4) NOT NULL,
	HOTEN varchar(40),
	SODT varchar(20),
	NGVL datetime,
	CONSTRAINT PK_NV PRIMARY KEY (MANV)
)

CREATE TABLE SANPHAM
(
	MASP char(4) NOT NULL,
	TENSP varchar(40),
	DVT varchar(20),
	NUOCSX varchar(40),
	GIA money,
	CONSTRAINT PK_SP PRIMARY KEY (MASP)
)

CREATE TABLE HOADON
(
	SOHD int NOT NULL,
	NGHD datetime,
	MAKH char(4),
	MANV char(4),
	TRIGIA money,
	CONSTRAINT PK_HD PRIMARY KEY (SOHD),
	CONSTRAINT FK_HD_KH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
	CONSTRAINT FK_HD_NV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
)

CREATE TABLE CTHD
(
	SOHD int NOT NULL,
	MASP char(4) NOT NULL,
	SL int,
	CONSTRAINT PK_CTHD PRIMARY KEY (SOHD,MASP),
	CONSTRAINT FK_CTHD_HD FOREIGN KEY (SOHD) REFERENCES HOADON(SOHD),
	CONSTRAINT FK_CTHD_SP FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)
)

-- Cau 2 --
ALTER TABLE SANPHAM ADD GHICHU varchar(20)
-- Cau 3 --
ALTER TABLE KHACHHANG ADD LOAIKH tinyint
-- Cau 4 --
ALTER TABLE SANPHAM ALTER COLUMN GHICHU varchar(100)
-- Cau 5 --
ALTER TABLE SANPHAM DROP COLUMN GHICHU
-- Cau 6 --
ALTER TABLE KHACHHANG ALTER COLUMN LOAIKH varchar(100)
ALTER TABLE KHACHHANG ADD CONSTRAINT KT_LOAIKH CHECK(LOAIKH IN ('Vang lai', 'Thuong xuyen', 'Vip'))
-- Cau 7 -- 
ALTER TABLE SANPHAM ADD CONSTRAINT KT_DVT CHECK(DVT IN ('cay', 'hop', 'cai', 'quyen', 'chuc')) 
-- Cau 8 --
ALTER TABLE SANPHAM ADD CONSTRAINT KT_GIABAN CHECK(GIA > 500) 
-- Cau 9 --
ALTER TABLE HOADON ADD CONSTRAINT KT_HD CHECK(SOHD >= 1)
-- Cau 10 --
ALTER TABLE KHACHHANG ADD CONSTRAINT KT_TV CHECK(NGDK > NGSINH)

INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK)
VALUES
('KH01', 'Nguyen Van A', '731 Tran Hung Dao, Q5, TpHCM', '08823451', '1960-10-22', 13060000, '2006-07-22'),
('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '0908256478', '1974-04-03', 280000, '2006-07-30'),
('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '0938776266', '1980-06-12', 3860000, '2006-08-05'),
('KH04', 'Tran Minh Long', '50/34 Le Dai Hanh, Q10, TpHCM', '0917325476', '1965-03-09', 250000, '2006-10-02'),
('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TpHCM', '08246108', '1950-03-10', 21000, '2006-10-28'),
('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '08631738', '1981-12-31', 915000, '2006-11-24'),
('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '0916783565', '1971-04-06', 12500, '2006-12-01'),
('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TpHCM', '0938435756', '1971-01-10', 365000, '2006-12-13'),
('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TpHCM', '08654763', '1979-09-03', 70000, '2007-01-14'),
('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TpHCM', '08768904', '1983-05-02', 67500, '2007-01-16');

INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) 
VALUES 
('NV01', 'Nguyen Nhu Nhut', '0927345678', '2006-04-13'),
('NV02', 'Le Thi Phi Yen', '0987567390', '2006-04-21'),
('NV03', 'Nguyen Van B', '0997047382', '2006-04-27'),
('NV04', 'Ngo Thanh Tuan', '0913758498', '2006-06-24'),
('NV05', 'Nguyen Thi Truc Thanh', '0918590387', '2006-07-20');

INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA)
VALUES
('BC01', 'But chi', 'cay', 'Singapore', 3000),
('BC02', 'But chi', 'cay', 'Singapore', 5000),
('BC03', 'But chi', 'cay', 'Viet Nam', 3500),
('BC04', 'But chi', 'hop', 'Viet Nam', 30000),
('BB01', 'But bi', 'cay', 'Viet Nam', 5000),
('BB02', 'But bi', 'cay', 'Trung Quoc', 7000),
('BB03', 'But bi', 'hop', 'Thai Lan', 100000),
('TV01', 'Tap 100 giay mong', 'quyen', 'Trung Quoc', 2500),
('TV02', 'Tap 200 giay mong', 'quyen', 'Trung Quoc', 4500),
('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', 3000),
('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', 5500),
('TV05', 'Tap 100 trang', 'chuc', 'Viet Nam', 23000),
('TV06', 'Tap 200 trang', 'chuc', 'Viet Nam', 53000),
('TV07', 'Tap 100 trang', 'chuc', 'Trung Quoc', 34000),
('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', 40000),
('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', 55000),
('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', 51000),
('ST04', 'So tay', 'quyen', 'Thai Lan', 55000),
('ST05', 'So tay mong', 'quyen', 'Thai Lan', 20000),
('ST06', 'Phan viet bang', 'hop', 'Viet Nam', 5000),
('ST07', 'Phan khong bui', 'hop', 'Viet Nam', 7000),
('ST08', 'Bong bang', 'cai', 'Viet Nam', 1000),
('ST09', 'But long', 'cay', 'Viet Nam', 5000),
('ST10', 'But long', 'cay', 'Trung Quoc', 7000);

INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA)
VALUES
(1001, '2006-07-23', 'KH01', 'NV01', 320000),
(1002, '2006-08-12', 'KH01', 'NV02', 840000),
(1003, '2006-08-23', 'KH02', 'NV01', 100000),
(1004, '2006-09-01', 'KH02', 'NV01', 180000),
(1005, '2006-10-20', 'KH01', 'NV02', 3800000),
(1006, '2006-10-16', 'KH01', 'NV03', 2430000),
(1007, '2006-10-28', 'KH03', 'NV03', 510000),
(1008, '2006-10-28', 'KH01', 'NV03', 440000),
(1009, '2006-10-28', 'KH03', 'NV04', 200000),
(1010, '2006-11-01', 'KH01', 'NV01', 5200000),
(1011, '2006-11-04', 'KH04', 'NV03', 250000),
(1012, '2006-11-30', 'KH05', 'NV03', 21000),
(1013, '2006-12-12', 'KH06', 'NV01', 5000),
(1014, '2006-12-31', 'KH03', 'NV02', 3150000),
(1015, '2007-01-01', 'KH06', 'NV01', 910000),
(1016, '2007-01-01', 'KH07', 'NV02', 12500),
(1017, '2007-01-02', 'KH08', 'NV03', 35000),
(1018, '2007-01-13', 'KH08', 'NV03', 330000),
(1019, '2007-01-13', 'KH01', 'NV03', 30000),
(1020, '2007-01-14', 'KH09', 'NV04', 70000),
(1021, '2007-01-16', 'KH10', 'NV03', 67500),
(1022, '2007-01-16', NULL, 'NV03', 7000),
(1023, '2007-01-17', NULL, 'NV01', 330000);

INSERT INTO CTHD (SOHD, MASP, SL)
VALUES
(1001, 'TV02', 10),
(1001, 'ST01', 5),
(1001, 'BC01', 5),
(1001, 'BC02', 10),
(1001, 'ST08', 10),
(1002, 'BC04', 20),
(1002, 'BB01', 20),
(1002, 'BB02', 20),
(1003, 'BB03', 10),
(1004, 'TV01', 20),
(1004, 'TV02', 10),
(1004, 'TV03', 10),
(1004, 'TV04', 10),
(1005, 'TV05', 50),
(1005, 'TV06', 50),
(1006, 'TV07', 20),
(1006, 'ST01', 30),
(1006, 'ST02', 10),
(1007, 'ST03', 10),
(1008, 'ST04', 8),
(1009, 'ST05', 10),
(1010, 'TV07', 50),
(1010, 'ST07', 50),
(1010, 'ST08', 100),
(1010, 'ST04', 50),
(1010, 'TV03', 100),
(1011, 'ST06', 50),
(1012, 'ST07', 3),
(1013, 'ST08', 5),
(1014, 'BC02', 80),
(1014, 'BB02', 100),
(1014, 'BC04', 60),
(1014, 'BB01', 50),
(1015, 'BB02', 30),
(1015, 'BB03', 7),
(1016, 'TV01', 5),
(1017, 'TV02', 1),
(1017, 'TV03', 1),
(1017, 'TV04', 5),
(1018, 'ST04', 6),
(1019, 'ST05', 1),
(1019, 'ST06', 2),
(1020, 'ST07', 10),
(1021, 'ST08', 5),
(1021, 'TV01', 7),
(1021, 'TV02', 10),
(1022, 'ST07', 1),
(1023, 'ST04', 6);

-- Phan 2 --
-- Bai Tap 3 --
-- Cau 2 --
SELECT * INTO SANPHAM1 FROM SANPHAM
SELECT * INTO KHACHHANG1 FROM KHACHHANG

-- Cau 3 --
UPDATE SANPHAM1
SET GIA = GIA * 1.05
WHERE NUOCSX = 'Thai Lan'

-- Cau 4 -- 
UPDATE SANPHAM1
SET GIA = GIA * 0.95
WHERE NUOCSX = 'Trung Quoc' AND (GIA < 10000)

-- Cau 5 --
UPDATE KHACHHANG1
SET LOAIKH = 'Vip'
WHERE ((NGDK < 1/1/2007) AND (DOANHSO >= 10000000)) OR ((NGDK > 1/1/2007) AND (DOANHSO >= 2000000)) 

-- Phan 3 --
-- Bai Tap 5 --
-- Cau 1 --
SELECT MASP, TENSP
FROM SANPHAM 
WHERE NUOCSX = 'Trung Quoc'

-- Cau 2 --
SELECT MASP, TENSP
FROM SANPHAM
WHERE DVT IN('cay', 'quyen')

-- Cau 3 --
SELECT MASP, TENSP
FROM SANPHAM
WHERE MASP LIKE 'B%01'

-- Cau 4 --
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' AND (GIA BETWEEN 30000 AND 40000)

-- Cau 5 --
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX IN('Trung Quoc', 'Thai Lan') AND (GIA BETWEEN 30000 AND 40000)

-- Cau 6 --
SELECT SOHD, TRIGIA
FROM HOADON
WHERE NGHD IN ('1/1/2007', '2/1/2007')

-- Cau 7 --
SELECT SOHD, TRIGIA
FROM HOADON
WHERE MONTH(NGHD) = 1 AND YEAR(NGHD) = 2007
ORDER BY NGHD ASC, TRIGIA DESC

-- Cau 8 -- 
SELECT DISTINCT KHACHHANG.MAKH, HOTEN
FROM HOADON
INNER JOIN KHACHHANG ON HOADON.MAKH = KHACHHANG.MAKH AND NGHD = '2007-1-1'

-- Cau 9 --
SELECT SOHD, TRIGIA
FROM NHANVIEN
INNER JOIN HOADON ON NHANVIEN.MANV = HOADON.MANV 
AND HOTEN = 'Nguyen Van B' AND NGHD = '2006-10-28'

-- Cau 10 --
SELECT DISTINCT SANPHAM.MASP, TENSP
FROM CTHD
INNER JOIN SANPHAM ON CTHD.MASP = SANPHAM.MASP
INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
INNER JOIN KHACHHANG ON HOADON.MAKH = KHACHHANG.MAKH
AND HOTEN = 'Nguyen Van A'
AND MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006

-- Cau 11 --
SELECT DISTINCT SOHD
FROM CTHD
WHERE MASP IN('BB01','BB02')

-------------------------------------------- TUAN 3 ---------------------------------------------------

-- Phan 3 --

-- Cau 12 --
SELECT DISTINCT SOHD
FROM CTHD
WHERE MASP IN('BB01','BB02') AND (SL BETWEEN 10 AND 20)

-- Cau 13 --
SELECT DISTINCT SOHD
FROM CTHD 
WHERE MASP IN('BB01') AND (SL BETWEEN 10 AND 20)
INTERSECT
(
	SELECT DISTINCT SOHD
	FROM CTHD
	WHERE MASP IN('BB02') AND (SL BETWEEN 10 AND 20)
)

-- Cau 14 --
SELECT DISTINCT SANPHAM.MASP, TENSP
FROM SANPHAM
INNER JOIN CTHD ON SANPHAM.MASP = CTHD.MASP
INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
AND ( NUOCSX = 'Trung Quoc' OR NGHD = '1/1/2007')

-- Cau 15 --
SELECT MASP, TENSP
FROM SANPHAM
WHERE MASP NOT IN(SELECT MASP FROM CTHD)

-- Cau 16 -- 
SELECT MASP, TENSP
FROM SANPHAM
WHERE MASP NOT IN(SELECT MASP
				  FROM CTHD 
				  INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
				  AND YEAR(NGHD) = 2006)

-- Cau 17 -- 
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' AND MASP NOT IN(SELECT MASP
											FROM CTHD 
											INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
											AND YEAR(NGHD) = 2006)

-- Cau 18 -- 
SELECT DISTINCT SOHD
FROM HOADON
WHERE NOT EXISTS ( SELECT *
				   FROM SANPHAM
				   WHERE NUOCSX = 'Singapore' AND NOT EXISTS ( SELECT *
															   FROM CTHD
															   WHERE CTHD.SOHD = HOADON.SOHD
															   AND CTHD.MASP = SANPHAM.MASP)
															   )
-- Cau 19 -- 
SELECT DISTINCT SOHD
FROM HOADON
WHERE YEAR(NGHD) = 2006 AND NOT EXISTS ( SELECT *
										 FROM SANPHAM
										 WHERE NUOCSX = 'Singapore' AND NOT EXISTS ( SELECT *
																					 FROM CTHD
																					 WHERE CTHD.SOHD = HOADON.SOHD
																					 AND CTHD.MASP = SANPHAM.MASP)
																					 )

----------------------------------------------------- TUAN 4 ------------------------------------------------------------

-- Phan 3 --
-- BAI TAP 1 --
-- Cau 20 --
SELECT COUNT(*) AS KhongPhaiKhachHang
FROM HOADON
WHERE MAKH IS NULL

-- Cau 21 --
SELECT COUNT(DISTINCT MASP) AS SanPhamKhacNhauBanRa
FROM CTHD
JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
AND YEAR(NGHD) = 2006

-- Cau 22 --
SELECT MAX(TRIGIA) AS MaxTriGia, MIN(TRIGIA) AS MinTriGia
FROM HOADON

-- Cau 23 --
SELECT AVG(TRIGIA) AS TriGia_TB
FROM HOADON
WHERE YEAR(NGHD) = 2006

-- Cau 24 --
SELECT SUM(TRIGIA) AS DoanhThu
FROM HOADON
WHERE YEAR(NGHD) = 2006

-- Cau 25 --
SELECT SOHD
FROM HOADON
WHERE YEAR(NGHD) = 2006 AND TRIGIA = ( SELECT MAX(TRIGIA) 
									   FROM HOADON
									   WHERE YEAR(NGHD) = 2006)

-- Cau 26 --
SELECT HOTEN
FROM KHACHHANG
JOIN HOADON ON KHACHHANG.MAKH = HOADON.MAKH
WHERE YEAR(NGHD) = 2006 AND TRIGIA = ( SELECT MAX(TRIGIA)
									   FROM HOADON
									   WHERE YEAR(NGHD) = 2006)

-- Cau 27 --
SELECT MAKH, HOTEN
FROM KHACHHANG
WHERE DOANHSO IN ( SELECT TOP(3) DOANHSO
				   FROM KHACHHANG
				   ORDER BY DOANHSO DESC)

-- Cau 28 --
SELECT MASP, TENSP
FROM SANPHAM
WHERE GIA IN ( SELECT DISTINCT TOP(3) GIA
			   FROM SANPHAM
			   ORDER BY GIA DESC)

-- Cau 29 -- 
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Thai Lan' AND GIA IN ( SELECT DISTINCT TOP(3) GIA
									   FROM SANPHAM
									   ORDER BY GIA DESC)

-- Cau 30 --
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' AND GIA IN ( SELECT DISTINCT TOP(3) GIA
										 FROM SANPHAM
										 WHERE NUOCSX = 'Trung Quoc'
										 ORDER BY GIA DESC)

-- BAI TAP 3 -- 
-- Cau 31 --
SELECT TOP(3) KHACHHANG.*, RANK() OVER(ORDER BY DOANHSO DESC) AS Top3KhachHang
FROM KHACHHANG

-- Cau 32 --
SELECT COUNT(DISTINCT MASP) AS TongSanPhamTrungQuoc
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc'

-- Cau 33 --
SELECT NUOCSX, COUNT(DISTINCT MASP) AS TongSanPham
FROM SANPHAM
GROUP BY NUOCSX

-- Cau 34 --
SELECT NUOCSX, MAX(GIA) AS MaxGia, MIN(GIA) AS MinGia, AVG(GIA) AS AvgGia
FROM SANPHAM
GROUP BY NUOCSX

-- Cau 35 --
SELECT NGHD, SUM(TRIGIA) AS DoanhThu
FROM HOADON
GROUP BY NGHD

-- Cau 36 --
SELECT MASP, SUM(SL) AS 'Tong so luong trong 10/2006'
FROM CTHD
JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
WHERE MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006
GROUP BY MASP

-- Cau 37 --
SELECT MONTH(NGHD) AS THANG, SUM(TRIGIA) AS DOANHTHU
FROM HOADON
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)

-- Cau 38 --
SELECT SOHD 'So hoa don mua it nhat 4 san pham'
FROM CTHD
GROUP BY SOHD
HAVING COUNT(MASP) >= 4

-- Cau 39 --
SELECT SOHD
FROM CTHD
JOIN SANPHAM ON CTHD.MASP = SANPHAM.MASP
AND NUOCSX = 'Viet Nam'
GROUP BY SOHD
HAVING COUNT(DISTINCT CTHD.MASP) >= 3

-- Cau 40 --
SELECT KHACHHANG.MAKH, HOTEN
FROM KHACHHANG
JOIN HOADON ON KHACHHANG.MAKH = HOADON.MAKH
GROUP BY KHACHHANG.MAKH, HOTEN
HAVING COUNT(SOHD) IN ( SELECT TOP(1) COUNT(SOHD)
						FROM HOADON
						GROUP BY MAKH
						ORDER BY COUNT(SOHD) DESC)

-- Cau 41 --
SELECT MONTH(NGHD) AS 'Thang trong nam 2006 co doanh thu cao nhat'
FROM HOADON
GROUP BY MONTH(NGHD)
HAVING MAX(TRIGIA) IN ( SELECT TOP(1) MAX(TRIGIA)
						FROM HOADON
						GROUP BY MONTH(NGHD)
						ORDER BY MAX(TRIGIA) DESC)

-- Cau 42 --
SELECT SANPHAM.MASP, TENSP
FROM SANPHAM
JOIN CTHD ON SANPHAM.MASP = CTHD.MASP
GROUP BY SANPHAM.MASP, TENSP
HAVING SUM(SL) IN ( SELECT TOP(1) SUM(SL)
					FROM CTHD 
					GROUP BY MASP
					ORDER BY SUM(SL) ASC)

-- Cau 43 --
SELECT B.NUOCSX, MASP, TENSP
FROM ( SELECT NUOCSX, MAX(GIA) AS GIACAONHAT
	   FROM SANPHAM
	   GROUP BY NUOCSX) AS B JOIN SANPHAM ON SANPHAM.GIA = B.GIACAONHAT
WHERE B.NUOCSX = SANPHAM.NUOCSX

-- Cau 44 --
SELECT NUOCSX
FROM SANPHAM
GROUP BY NUOCSX
HAVING COUNT(DISTINCT MASP) >= 3

-- Cau 45 --
SELECT *
FROM KHACHHANG
WHERE MAKH IN ( SELECT TOP(1) A.MAKH
				FROM ( SELECT TOP(10) MAKH
				       FROM KHACHHANG
					   ORDER BY DOANHSO DESC) AS A 
					   JOIN 
					   ( SELECT MAKH, COUNT(SOHD) AS 'SoLanMuaHang'
					     FROM HOADON
						 GROUP BY MAKH) AS B
						 ON A.MAKH = B.MAKH
				ORDER BY SoLanMuaHang DESC)

------------------------------------------------------TUAN 5------------------------------------------------------

--PHAN 1--

-- Cau 11 --
CREATE TRIGGER trig_ins_up_hoadon_NGHD ON HOADON
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @MAKH varchar(4), @NGHD datetime, @NGDK datetime
	SELECT @MAKH = MAKH, @NGHD = NGHD FROM INSERTED 
	SELECT @NGDK = NGDK FROM KHACHHANG WHERE @MAKH = MAKH
	IF (@NGDK > @NGHD)
	BEGIN
		PRINT 'NGDK PHAI < NGHD'
		ROLLBACK TRAN
	END
	ELSE 
	BEGIN 
		PRINT 'THANH CONG'
	END
END

CREATE TRIGGER trig_up_hoadon_NGDK ON KHACHHANG
FOR UPDATE
AS
BEGIN
	DECLARE @MAKH varchar(4), @NGDK datetime, @NGHD datetime
	SELECT @MAKH = MAKH, @NGDK = NGDK FROM INSERTED
	SELECT @NGHD = NGHD FROM HOADON WHERE @MAKH = MAKH
	IF (@NGDK < @NGHD)
	BEGIN
		PRINT 'UPDATE THANH CONG'
	END
	ELSE
	BEGIN
		PRINT 'KHONG THANH CONG: NGDK < NGHD'
		ROLLBACK TRAN
	END
END

-- Cau 12 -- 
CREATE TRIGGER trig_ins_up_CAU12 ON HOADON
FOR INSERT, UPDATE
AS 
BEGIN
	DECLARE @NGHD datetime, @MANV char(4), @NGVL smalldatetime
	SELECT @MANV = MANV, @NGHD = NGHD FROM INSERTED
	SELECT @NGVL = NGVL FROM NHANVIEN WHERE @MANV = MANV
	IF (@NGHD < @NGVL)
	BEGIN 
		PRINT 'ERROR: NGHD > NGVL'
		ROLLBACK TRAN
	END
	ELSE
	BEGIN
		PRINT 'THANH CONG'
	END
END

CREATE TRIGGER trig_up_CAU12 ON NHANVIEN
FOR UPDATE
AS 
BEGIN
	DECLARE @MANV char(4), @NGHD datetime, @NGVL smalldatetime
	SELECT @MANV = MANV, @NGVL = NGVL FROM INSERTED 
	SELECT @NGHD = NGHD FROM HOADON WHERE @MANV = MANV
	IF (@NGHD >= @NGVL)
	BEGIN
		PRINT 'UPDATE THANH CONG'
	END
	ELSE
	BEGIN
		PRINT 'UPDATE KHONG THANH CONG: NGHD > NGVL'
		ROLLBACK TRAN
	END
END

-- Cau 13 -- 
CREATE TRIGGER trig_del_CAU13 ON CTHD
FOR DELETE
AS 
BEGIN
	DECLARE @SOHD int
	SELECT @SOHD = SOHD FROM DELETED
	IF ((SELECT COUNT(*) FROM CTHD WHERE SOHD = @SOHD) = 0)
	BEGIN
		PRINT 'Phai co it nhat 1 chi tiet hoa don' 
		ROLLBACK TRAN
	END
	ELSE 
	BEGIN
		PRINT 'Da xoa thanh cong'
	END
END

-- Cau 15 --
CREATE TRIGGER trig_up_CAU15 ON KHACHHANG
FOR UPDATE
AS
BEGIN
	DECLARE @Doanhso money, @TongTriGia money
	SELECT @Doanhso = DOANHSO FROM INSERTED
	
	SELECT @TongTriGia = SUM(TRIGIA) 
	FROM HOADON, INSERTED 
	WHERE HOADON.MAKH = INSERTED.MAKH

	IF (@Doanhso <> @TongTriGia)
	BEGIN
		PRINT 'Doanh so cua mot khach hang la tong tri gia cac hoa don ma khach hang thanh vien da mua'
		ROLLBACK TRAN
	END
END









